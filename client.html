<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Multiple File Upload, Preview and Remove</title>
    <!--   Latest compiled and minified CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="assets/css/bootstrap-theme.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class = "header">
                <div class = "firstheader">
                    <img src="./assets/img/call of duty mobile.jpeg">
                    <img src="./assets/img/clash-of-queens-light-or-darkness.jpeg">
                    <img src="./assets/img/Evony.jpeg">
                    <img src="./assets/img/rise of firtborn.jpeg">
                    <img src="./assets/img/sos.jpag.jpeg">
                </div>
                <div calss = "secondheader" style="display: flex; height: 200px;">
                    <img src="./assets/img/Vikings_War_of_Clans.jpeg" style="width: 20%">
                    <img src="./assets/img/screen Shot 2022-10-06 at 1.01.24 AM.png" style="width: 20%">
                    <h1 style="width: 40%; text-align: center; align-items: center; display: flex;">MOBILE GAMING ENTERTAINMENT SALES</h1>
                    <img src="./assets/img/wolf-game.jpeg" style="width: 20%">
                </div>
            </div>
            <div class = "row" style="display: flex; margin-top: 35px;">
                <div class = "col-md-6" style="text-align: center;">
                    <h1>Contact</h1>
                    <br />
                    <div class="card card-body" style="line-height: 200%;
                    flex-flow: column;
                    flex-direction: unset">
                        <b>Website :</b> MobileGamingEntertainmentSales.com<br />
                        <b>Email :</b> fksocietyrobot121@gmail.com<br />
                        <b>Whatsapp number :</b> +1 272-201-8492<br />
                        <b>Discord :</b> The_Ragnar#7379
                    </div>
                </div>

                <div class = "col-md-6" style="text-align: center;">
                    <h1>Payment</h1>
                    <br />
                    <div class="card card-body" style="line-height: 200%;
                    flex-flow: column;
                    flex-direction: unset">

		                <b>Cashapp payment :</b> https://cash.app/$ironthronesales <br />
                        <b>Paypal :</b> https://paypal.me/evonysalesinc?country.x=US&locale.x=en_US
                       <b> Line id : </b>xwarchiefnatox
                    </div>
                </div>
            </div>
            <h1 style="text-align: center; margin-top: 70px;">Game Accounts</h1>
            <hr />
            <div class = "container-fluid  uploaded" id="uploaded_images" style="width: 100%; height:100%; display:flex; flex-direction:row;flex-wrap:wrap; align-items:stretch; justify-content:center;"></div>
            <div class="clearfix h-50"></div>
            <div class="col-md-12" style="margin-top: 20px">
                <div class="panel panel-primary">

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/jquery-3-3-1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jquery.ui.widget@1.10.3/jquery.ui.widget.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.fileupload.min.js" integrity="sha512-P7EUiLYW7QUrhYrLgaJ++ok2j2I7Pu0UgGnrpLowujPZicu7mIR0V/Trq+7kl/0nEkp6yNGh8eFJY1JUv3dkPA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-jquery-file-upload/2.13.0/cloudinary-jquery-file-upload.min.js" integrity="sha512-hqy9DJ09+zEbb275s2UFHv+8SO1jxrkCeK7DYNFsTEFh3181QxgehQzyVVb/FUxI1JglXnic3e2aOi2gXEIMpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/jquery.validate.min.js"></script>
    <script src="assets/js/additional-methods.js"></script>
    <script src="//static.filestackapi.com/filestack-js/3.x.x/filestack.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-analytics.js";
        import { getAuth } from 'https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js'
        import { getFirestore, collection, addDoc,getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js'
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.12.1/firebase-storage.js'
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBKL_tEnK6Ax34sLW-ZWC1-aVJXZgqm_TM",
          authDomain: "mobilegamingentertainmentsales.firebaseapp.com",
          projectId: "mobilegamingentertainmentsales",
          storageBucket: "mobilegamingentertainmentsales.appspot.com",
          messagingSenderId: "834302892047",
          appId: "1:834302892047:web:798a6dbb815483a2d0eb7a",
          measurementId: "G-Z3JPZHYZ6H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage(app);


 async function handleUpload(file){
            if(!file){

            }else{
                let storageRef =  ref(storage, '/files/'+file.name+ Date.now())
                const uploadTask =  uploadBytesResumable(storageRef, file);
                return uploadTask;

            }
        }
        async function addData(data){

        try {
            const docRef = await addDoc(collection(db, "uploadedimages"), data);
            console.log("Document written with ID: ", docRef.id);
        } catch (e) {
            console.error("Error adding document: ", e);
        }

        }


        async function getAllData(){
            const querySnapshot = await getDocs(collection(db, "uploadedimages"));
            console.log(querySnapshot);
            return querySnapshot;



        }
        async function updateData(data, id){
            const washingtonRef = doc(db, "uploadedimages", id);
            await updateDoc(washingtonRef,data);

        }

        async function deleteDocs(id){
            await deleteDoc(doc(db, "uploadedimages", id));
        }



        $(document).ready(function(){
            $.validator.addMethod('maxSize', function (value, element, param) {
                return this.optional(element) || (element.files[0].size <= param)
            }, 'File size must be less than {0} KB');


            var fileArr = [];
            var eventArray;
            var interna;
            var res;
            async function loadImages(){
               let querySnapshot = await getAllData();
                let divPag = $("#uploaded_images");

               setTimeout(()=>{
                querySnapshot.forEach((doc) => {
                    console.log(doc.data()['name'])
                    divPag.append(imageDescription(doc.data(),doc.id));
                    console.log(`${doc.id} => ${doc.data()}`);
                  });
               },10000)
                //for (let i in arr_image){
                  //  divPag.append(imageDescription(arr_image[i],i));
                //}
            }
            $('body').on('click','#submit-btn-edits', async function(){
                console.log()
               // if(status!="edit") {return;}
               var i = $(this).val();
                console.log(i)
                let dt = localStorage.getItem('data');
                let item = JSON.parse(dt);

                var toEdit = $("#textarea-action-edit"+i).val();
            var m= {"description": toEdit};
                await updateData(m,i)
                //localStorage.setItem('data', JSON.stringify(item))
                //console.log(item);

                window.location.reload(true);
            })

            function imageDescription(image,i){
                console.log(image['src']);
                let data =`
                <div class='img-div' style="width:25%; height:50%;" id='img-div${i}' class="pb-2 mb-3">
                    <img src='${image["src"]}' class='img-responsive image img-thumbnail' id="show${i}"><br/>
                    <div class=${image["timestamp"]} id="textarea-action-show${i}" >
                        ${image["description"]}
                    </div>


                </div>
                <div class='clear-fix'></div>
                `



                return data;
            }
            $('#form-upload').validate({
                /* maxSize value should be provided in kb e.g (1048576 * 1) for 1MB */
                rules: {
                    "images[]": { required: true,  accept:"image/jpeg,image/png", maxSize: 1048576}
                },
                messages: {
                    "images[]": {
                        required: 'No file has been chosen yet.',
                        accept: 'Please upload .png or .jpg or .jpeg format',
                        maxSize: `Image size cannot be greater than {0} KB.`
                    }
                },
                onblur: "true",
                onfocus: "true",
                errorClass: "help-block",
                errorElement: "strong",
                highlight: function (element) {
                    $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
                },
                unhighlight: function (element) {
                    $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
                },
                errorPlacement: function (error, element) {
                    if (element.parent('input-group').length) {
                        error.insertAfter(element.parent())
                        return false
                    } else {
                        error.insertAfter(element)
                        return false
                    }
                }
            });


            $('#form-upload').submit(async ()=> {
                //event.preventDefault();
               //let dt = localStorage.getItem('data');
                //let item = dt ==null? []: JSON.parse(dt);
                let pictures = JSON.parse(localStorage.getItem('pictures'));

                if(fileArr.length > 0){
                for (let [key, value] in fileArr){
                    console.log(`#textarea-action${key}`)
                    let name = fileArr[key].name;
                    let imageObj = {
                        name: name,
                        timestamp: Date.now(),
                        description:$(`#textarea-action${key}`).val(),
                        src:pictures[key]['src']
                      };
                    // item.push(imageObj)
                   await addData(imageObj);
                   // console.log(item);
                   // localStorage.setItem('data',JSON.stringify(item));
                }
               //setTimeout(()=>{
                loadImages();
                localStorage.removeItem('pictures');
               //}, 7000)
                //console.log(item);



                }
            });

            $("#images").change(async function () {
                // check if fileArr length is greater than 0
                if (fileArr.length > 0) fileArr = [];
                $('#submit-btn').prop('disabled',true);
                $('#image_preview').html("");
                var total_file = document.getElementById("images").files;

                var i;
                if (!total_file.length) return;
                var pictures =[];
                for (i = 0; i < total_file.length; i++) {
                    if (total_file[i].size > 1048576) {
                        document.querySelector('#submit-btn').setAttribute('disabled', true);
                        return false;
                    } else {
                        fileArr.push(total_file[i]);
                        let name = total_file[i].name;
                        eventArray = event.target.files;
                            let myd = {
                                "index":i
                            }
                            console.log(myd);
                            let file = event.target.files[i];
                            let storageRef =  ref(storage, '/files/'+file.name+ Date.now())
                            const uploadTask =  uploadBytesResumable(storageRef, file);
                            uploadTask.on(
                    "state_changed",
                    (snapshot) => {
                        const percent = Math.round(
                            (snapshot.bytesTransferred / snapshot.totalBytes) * 100
                        );

                        // update progress
                        console.log(percent);
                    },
                    (err) => console.log(err),
                    () => {
                        // download url
                        getDownloadURL(uploadTask.snapshot.ref).then((url) => {
                            console.log(url);
                           localStorage.setItem('currentImage', url);
                           myd["src"]=url;
                            var src= url;
                             pictures.push(myd);
                            console.log(myd["index"])
                            i= myd["index"];
                             $('#image_preview').append(
                                 `<div class='img-div' id='img-div${i}'>
                                    <img src='${src}' class='img-responsive image img-thumbnail' id="show${i}"><br/>
                                    <textarea id="textarea-action${i}" rows="4" cols="4" class="form-control" name="form${i}">

                                    </textarea>
                                    <div class='middle'>
                                        <button id='action-icon' value='img-div${i}' class='btn btn-danger' role='${name}'>
                                            <i class='glyphicon glyphicon-trash'></i>
                                        </button>
                                    </div>
                                </div>
                                <div class='clear-fix'></div>
                                `
                             );
                        });
                    }
                )


                    }
                }
                setTimeout(()=>{
                localStorage.setItem('pictures', JSON.stringify(pictures));
                $('#submit-btn').prop('disabled', false);
                },12000);
            });

            $('body').on('click', '#action-icon', function (evt) {
                var divName = this.value;
                var fileName = $(this).attr('role');
                var total_file = fileArr;

                for (var i = 0; i < fileArr.length; i++) {
                    if (fileArr[i].name === fileName) {
                        fileArr.splice(i, 1);
                    }
                }

                document.getElementById('images').files = FileListItem(fileArr);
                $(`#${divName}`).remove();
                evt.preventDefault();
            })

            $('body').on('click', '#action-icon-edit', function (evt) {
                var divName = this.value;
                var fileName = $(`[role=form${divName}]`);
                console.log(fileName);
                console.log($(`#textarea-action-show${divName}`).is(":hidden"));
                if($(`#textarea-action-show${divName}`).is(":hidden")){
                    $(`#textarea-action-show${divName}`).show();
                    fileName.css({"display":"none"})
                }else{
                    $(`#textarea-action-show${divName}`).hide();
                    fileName.css({"display":"block"})
                }



                //
                evt.preventDefault();
            })
            $('body').on('click', '#action-icon-delete', async function (evt) {
                evt.preventDefault();
                var divName = this.value;
                var fileName = $(this).attr('role');
                var total_files = JSON.parse(localStorage.getItem('data'));

                console.log(divName);
                await deleteDocs(divName);

                //for (var i = 0; i <total_files.length; i++) {
                  //  console.log(total_files[i].timestamp);
                    //if (total_files[i].timestamp == fileName) {
                      //  console.log("here");

                        //total_files.splice(i, 1);
                    //}
                //}


              //  localStorage.setItem('data', JSON.stringify(total_files))
                window.location.reload(true);
               // document.getElementById('images').files = FileListItem(fileArr);
               // $(`#${divName}`).remove();

            })

            function attachElement(i,name,src){
                //var pic = JSON.parse(localStorage.getItem('pictures'))
               // console.log(pic.length)
                //i = pic.length -1
                // "<div class='img-div' id='img-div" + i + "'><img src='" + URL.createObjectURL(event.target.files[i]) + "' class='img-responsive image img-thumbnail'><div class='middle'><button id='action-icon' value='img-div" + i + "' class='btn btn-danger' role='" + total_file[i].name + "'><i class='glyphicon glyphicon-trash'></i></button></div></div><div class='clear-fix'></div>"
                var item = `<div class='img-div' id='img-div${i}'>
                                <img src='${src}' class='img-responsive image img-thumbnail' id="show${i}"><br/>
                                <textarea id="textarea-action${i}" rows="4" cols="4" class="form-control" name="form${i}">

                                </textarea>
                                <div class='middle'>
                                    <button id='action-icon' value='img-div${i}' class='btn btn-danger' role='${name}'>
                                        <i class='glyphicon glyphicon-trash'></i>
                                    </button>
                                </div>
                            </div>
                            <div class='clear-fix'></div>
                            `;
                return item;


            }

            loadImages();


        })

        function FileListItem(file) {
            file = [].slice.call(Array.isArray(file) ? file : arguments)
            for (var c, b = c = file.length, d = !0; b-- && d;) d = file[b] instanceof File
            if (!d) throw new TypeError("expected argument to FileList is File or array of File objects")
            for (b = (new ClipboardEvent("")).clipboardData || new DataTransfer; c--;) b.items.add(file[c])
            return b.files
        }
    </script>
</body>
</html>